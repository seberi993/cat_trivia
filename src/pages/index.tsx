import { type NextPage } from "next";
import Head from "next/head";
import getTriviaFromAPI from "./api/getTriviaFromAPI";
import { useState } from "react";
import Image from "next/image";
import getCatFromAPI from "./api/getCatFromAPI";
import pickRandomBorder from '../utils/pickRandomBorder'
import { Container } from "postcss";
//TODO need to add authentication with google, and save cat collection to account
const array: any[] = [];

/*
AVAILABLE CATEGORIES FOR TRIVIA

artliterature
language
sciencenature
general
fooddrink
peopleplaces
geography
historyholidays
entertainment
toysgames
music
mathematics
religionmythology
sportsleisure

*/
const Home: NextPage = () => {
  const [question, setQuestion] = useState("Click the button");
  const [correctAnswer, setCorrectAnswer] = useState("");
  const [firstTry, setFirstTry] = useState(true);
  const [isWinning, userHasWon] = useState(false);
  const [visibility, setVisibility] = useState(false);
  const [cat, setCat] = useState(Object);
  const [inputVisibility, setInputVisibility] = useState(false);
  // const [fact, setFact] = useState("");
  const [score, setPlayerScore] = useState(0);
  const [userHint, setHint] = useState("");
 
  async function clickHandler() {
    if (firstTry) {
      setFirstTry(false);
    }
    console.log("IS first try: ", firstTry);
    setHint("");
    const data = await getTriviaFromAPI();
    const cat = await getCatFromAPI();

    //const myFact = await getFactFromAPI();
    // setFact(myFact);
    console.log("!CAT", cat);
    setCat(cat);
    
    setQuestion(data[0].question);
    setCorrectAnswer(data[0].answer);
    setVisibility(false);
    userHasWon(false);
    setInputVisibility(true);
  }

  const increaseScore = (amount:number) => {
    for(let i = 0; i < amount; i++){
    setPlayerScore((score) => score + 1);
  }
  };

  const decreaseScore = (amount:number) => {
    for(let i = 0; i < amount; i++){
      setPlayerScore((score) => score - 1);
    }
   
  };

  const answerHandler = async () => {
    console.log("Checking answers...");
    const userInput = document.getElementById(
      "fname"
    ) as HTMLInputElement | null;
    const value = userInput?.value;
    if(value?.length===0){
      alert("Do something!");
      return;
    }
    console.log("The correct answer was [" + correctAnswer + "]");

    if(correctAnswer?.includes(value)&& value != " "){
      console.log("Close enough!"); //user guesses something right
      increaseScore(2);
      userHasWon(true);
      setVisibility(false);
      setInputVisibility(false);
   
      
    }

    if (correctAnswer.toLowerCase() === value?.toLowerCase() ) {
      //user is spot on =) 
      //TODO Need to implement prisma to add cats to database.
      userHasWon(true);
      setVisibility(false);
      setInputVisibility(false);

      
      increaseScore(5);
    }
  };
  const showCat = () => {
    setVisibility(true);
    userHasWon(false);
  };


  const showHint = () => {
    
    if(score > 0){
      decreaseScore(1);
      const first = correctAnswer.charAt(0);
      setHint(first.toString());
    }else{
     alert("You need more score for that");
    }
  };
  const cheat = () => {

    console.log(correctAnswer);
    const textArea = document.getElementById(
      "fname"
    ) as HTMLInputElement | null;
    if(textArea != null){
      textArea.value=correctAnswer;
    }

  };

  let price = 0;
  const saveCat = () => {
    console.log("You saved", cat.props.data[0].url);
    

    console.log("price:", price);
    if(price < score){
      decreaseScore(price);
      array.push(cat.props.data[0].url)
      
    }else{
      alert("You cant afford that cat");
      return;
    }
    setVisibility(false);
  };

  

  const setBorderColor = () => {
    const border = pickRandomBorder();

    if(border==="border-legendary"){
      price=35;
    }
    if(border ==="border-epic"){
      price=15;
    }
    if(border === "border-rare"){
      price = 9;
    }
    if(border === "border-uncommon"){
      price = 7
    }
    if(border ==="border-common"){
      price=3;
    }
    if(border==="border-trash"){
      price=1;
    }
    console.log(border);
    return border;
  };


  
  const showInventory = () =>{
    console.log(array);
  }

  return (
    <>
      <Head>
        <title>cats cats cats cats cats cats cats cats cats</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <p className="absolute top-0  text-#a3c8e5 inline-flex items-center rounded p-2 text-xl font-semibold">
          {score}
        </p>
      <button
          onClick={cheat}
          className="absolute right-80 left-80 rounded-full bg-blue_light py-2 px-4 font-bold text-white hover:bg-blue_dark"
        >
          {" "}
          Cheat
        </button>

      <main className=" grid place-items-center max-h-screen min-h-screen  bg-gradient-to-t from-background_dark to-background_bright">
        
        {isWinning ? (
                <button
                  className=" grid rounded-full bg-text_field py-2 px-4 font-bold text-white hover:bg-uncommon"onClick={showCat}>
                  SHOW CAT
                </button>
            ) : (
              <div >
                {firstTry ? (
                  <div>
                   <div className="max-h-screen  text-center text-xl font-bold">
                   Welcome to the cat trivia, press the button</div>
                    <button
                      className="absolute grid place-items-center top-80 rounded-full bg-text_field py-2 px-24 font-bold text-white hover:bg-blue_dark"
                      onClick={clickHandler}>
                      THE BUTTON
                    </button>
                    </div>) : (
                  <div>
                    <button
                      className="absolute top-80 right-5 rounded-full bg-text_field py-2 px-4 font-bold text-white hover:bg-blue_dark"
                      onClick={clickHandler}>
                      Next
                    </button>
                    <button onClick={showInventory} className="absolute top-10  left-0 rounded-lg bg-text_field font-bold text-white hover:bg-bag"
                    >Bag</button>
                  </div>
                )}
              </div>
            )}
      
        <div >
          {inputVisibility ? (
              <h3 className="text-gray-900 text-center text-xl font-bold">
                {question}
              </h3>
          ) : (
            <div></div>
          )}
          {inputVisibility ? (
            <div className=" grid place-items-center ">
              <textarea
                className=" text-black static bg-text_field py-2 px-4 font-bold hover:bg-text_dark"
                id="fname"
                name="fname"
              ></textarea>
              <button
                className="relative rounded-full bg-text_field py-2 px-4 font-bold text-white hover:bg-blue_dark"
                onClick={answerHandler}
              >
                Submit
              </button>{" "}
              <button
                className=" absolute left-0 top-80 rounded-full bg-text_field py-2 px-4 font-bold text-white hover:bg-blue_dark"
                onClick={showHint}
              >show hint
              </button>
              <div className="blur-sm text-6xl">{userHint}</div>
            </div>
          ) : (
            <div></div>
          )}
          
        </div>
        <div className="static">
            {visibility ? (
              <div className=" grid  place-items-center">
                <Image
                  className={`${setBorderColor()} border-solid h-auto w-auto rounded-lg border-8 object-cover`}
                  src={cat.props.data[0].url}
                  alt=""
                  width={cat.props.data[0].width} 
                  height={cat.props.data[0].width}
                ></Image>
                
                <button
                  onClick={saveCat}
                  className="bg-text_field relative rounded-full  py-2 px-4 font-bold text-white  hover:bg-blue_dark"
                >
                  Buy cat
                </button>
              </div>
            ) : (
              <div>
                <p className="font-bold grid place-items-center"></p>
              </div>
            )}
          </div>
      </main>
    </>
  );
};

export default Home;
